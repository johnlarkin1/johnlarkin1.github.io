<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta property="og:image" content="http://localhost:4000/assets/img/posts/imessage-parsing-slim.jpg"> <!-- Begin Jekyll SEO tag v2.8.0 --><title>iMessage Parsing and Analysis | Where will you go next?</title><meta name="generator" content="Jekyll v3.9.2" /><meta property="og:title" content="iMessage Parsing and Analysis" /><meta name="author" content="johnlarkin1" /><meta property="og:locale" content="en_US" /><meta name="description" content="You know what kinda sucks? A lot of basic features in iMessages on both macOS and iOS. So I’ve built a command line tool dubbed messages to help alleviate some of those pains." /><meta property="og:description" content="You know what kinda sucks? A lot of basic features in iMessages on both macOS and iOS. So I’ve built a command line tool dubbed messages to help alleviate some of those pains." /><link rel="canonical" href="http://localhost:4000/2022/message-parser/" /><meta property="og:url" content="http://localhost:4000/2022/message-parser/" /><meta property="og:site_name" content="Where will you go next?" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-05T00:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="iMessage Parsing and Analysis" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"johnlarkin1"},"dateModified":"2022-06-05T00:00:00-04:00","datePublished":"2022-06-05T00:00:00-04:00","description":"You know what kinda sucks? A lot of basic features in iMessages on both macOS and iOS. So I’ve built a command line tool dubbed messages to help alleviate some of those pains.","headline":"iMessage Parsing and Analysis","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2022/message-parser/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/images/mountain.png"},"name":"johnlarkin1"},"url":"http://localhost:4000/2022/message-parser/"}</script> <!-- End Jekyll SEO tag --><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/icons/apple-touch-icon.png?v=qA3OXqyw77"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/icons/favicon-32x32.png?v=qA3OXqyw77"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/icons/favicon-16x16.png?v=qA3OXqyw77"><link rel="manifest" href="/assets/img/icons/manifest.json?v=qA3OXqyw77"><link rel="mask-icon" href="/assets/img/icons/safari-pinned-tab.svg?v=qA3OXqyw77" color="#5bbad5"> <!--[if IE]><link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77"><![endif]--><link rel="shortcut icon" href="/assets/img/icons/favicon.ico?v=qA3OXqyw77"><meta name="apple-mobile-web-app-title" content="Sleek"><meta name="application-name" content="Sleek"><meta name="msapplication-config" content="/assets/img/icons/browserconfig.xml?v=qA3OXqyw77"><meta name="theme-color" content="#ffffff"> <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-KDHGNV6"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'GTM-KDHGNV6'); </script><style class="inlineCSS"> h1{color:#313237;margin-top:0;margin-bottom:.5rem}.dark-bg{background-color:#313237}@media only screen and (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:last-of-type,.post-card:nth-child(2n+2){margin-right:0}}html{line-height:1.15;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}header,nav,section{display:block}h1{font-size:2em;margin:.67em 0}figure,main{display:block}figure{margin:1em 40px}a{background-color:transparent;-webkit-text-decoration-skip:objects}img{border-style:none}svg:not(:root){overflow:hidden}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{-webkit-box-sizing:border-box;box-sizing:border-box}body{-webkit-overflow-scrolling:touch}*,::after,::before{-webkit-box-sizing:inherit;box-sizing:inherit}.site{display:-webkit-box;display:-ms-flexbox;display:flex;min-height:100vh;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column}.site__content{-webkit-box-flex:1;-ms-flex:1;flex:1}img{max-width:100%;height:auto;width:auto;vertical-align:middle}figure{margin:0}body{background-color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif;font-size:1rem;line-height:1.5;color:#343851;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%}p{margin-top:0;margin-bottom:1.25rem}h1,h2{color:#313237;margin-top:0;margin-bottom:.5rem}a{color:#277cea;text-decoration:none;border-bottom:1px dashed #277cea}.blur{background:#fff;filter:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"><filter id="filter"><feGaussianBlur stdDeviation="16" /></filter></svg>#filter');-webkit-filter:blur(1rem);filter:blur(1rem)}.container{padding:0 20px;max-width:100%;margin:0 auto}@media only screen and (min-width:36em){.container{max-width:540px;margin:0 auto}}@media only screen and (min-width:48em){.container{max-width:720px;margin:0 auto}}@media only screen and (min-width:62em){.container{max-width:960px;margin:0 auto}}@media only screen and (min-width:75em){.container{max-width:1170px;margin:0 auto}}.header{background-color:#fff;color:#343851;position:absolute;z-index:4;width:100%;top:0;left:0;will-change:transform;-webkit-transform:translateY(0);transform:translateY(0)}.header a{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border-bottom:0}.header__logo{display:-webkit-box;display:-ms-flexbox;display:flex;height:100%;overflow:hidden;padding:19px 0;margin-right:1.25rem;outline:0;border-bottom:0;color:#313237}.header__logo .header__logo--container{width:58px}.header__logo .header__logo--container .logo{fill:currentColor}.header__inner{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:3.75em;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.header__links{padding-bottom:.5rem;display:none;position:absolute;top:3.75em;left:0;width:100%;height:auto;background:#fff}.header__link{color:#343851;padding:.938rem 0;border-top:1px solid #ededed}.header__toggle{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;width:44px;height:100%;background-color:transparent;padding-left:1.25rem}.header__toggle span{display:block;position:relative;margin-top:4px;background-color:#343851;width:100%;height:2px;border-radius:1px}.header__toggle span:first-child{margin-top:0}@media (min-width:62em){.header__toggle{display:none;visibility:hidden}.header__links{position:static;padding:0;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-direction:column;flex-direction:column;visibility:visible;width:auto;height:100%}.header__links-wrapper{display:-webkit-box;display:-ms-flexbox;display:flex;height:100%;padding:0}.header__link{position:relative;padding:.938rem 1rem;border:0;height:100%}.header__link::after{content:"";display:block;position:absolute;left:0;bottom:0;height:3px;width:100%;-webkit-transform:scaleX(0);transform:scaleX(0);background:#277cea}}.post-card{display:block;position:relative;width:100%;min-height:250px;border-radius:4px;overflow:hidden;background-color:#fff;-webkit-box-shadow:0 1px 3px rgba(0,0,0,.08);box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:2.25rem;border-bottom:0}@media only screen and (min-width:48em){.post-card{width:48.4375%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:0}}@media only screen and (min-width:75em){.post-card{width:31.25%;margin-right:3.125%}.post-card:nth-child(2n+2){margin-right:3.125%}}.post-card__label{position:absolute;top:1.5rem;left:1.5rem;z-index:2}.post-card__inner{display:block;position:relative;padding:1.875rem 1.25rem .625rem;width:100%;color:#838c8d;border-bottom:0}.post-card__header{margin-bottom:.75rem}.post-card__meta{font-size:.875rem}.post-card__thumb{margin:0;background:#fff;position:relative;overflow:hidden}.post-card__thumb::after{content:"";display:block;height:0;width:100%;padding-bottom:56.25%}.post-card__thumb>*{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.label{padding:0 10px;margin-bottom:1rem;display:inline-block;line-height:20px;font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.8);border:2px solid rgba(255,255,255,.5);border-radius:100px}.hero{margin:3.75rem auto 0;min-height:16.25rem;width:100%;position:relative;background-color:#dde5ea;background-repeat:no-repeat;background-position:50%;background-size:cover}@media only screen and (min-width:62em){.hero{margin:0 auto;height:36em}}.hero::before{position:absolute;display:block;content:"";top:0;left:0;width:100%;height:100%;background:rgba(52,56,81,.8)}.hero__wrap{position:absolute;margin:auto;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);text-align:center;color:rgba(255,255,255,.8);width:100%;max-width:90%;z-index:1}.hero__wrap .hero__title{font-size:1.8em;color:#fff}.blog{background-color:#f9f9f9}.post-list{padding-top:2.5em;display:-webkit-box;display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-flex:1;-ms-flex:1 0 auto;flex:1 0 auto}@media only screen and (min-width:48em){.hero__wrap{max-width:40em}.hero__wrap .hero__title{padding:1rem 0;font-size:2.625em;line-height:3.125rem}.post-list{padding-top:5em}}</style><link rel="preload" href="/assets/css/main.css" as="style" onload="this.rel='stylesheet'"> <noscript><link rel="stylesheet" href="/assets/css/main.css"></noscript> <script type="text/javascript"> /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */ (function(w){"use strict";if(!w.loadCSS){w.loadCSS=function(){}} var rp=loadCSS.relpreload={};rp.support=(function(){var ret;try{ret=w.document.createElement("link").relList.supports("preload")}catch(e){ret=!1} return function(){return ret}})();rp.bindMediaToggle=function(link){var finalMedia=link.media||"all";function enableStylesheet(){link.media=finalMedia} if(link.addEventListener){link.addEventListener("load",enableStylesheet)}else if(link.attachEvent){link.attachEvent("onload",enableStylesheet)} setTimeout(function(){link.rel="stylesheet";link.media="only x"});setTimeout(enableStylesheet,3000)};rp.poly=function(){if(rp.support()){return} var links=w.document.getElementsByTagName("link");for(var i=0;i<links.length;i++){var link=links[i];if(link.rel==="preload"&&link.getAttribute("as")==="style"&&!link.getAttribute("data-loadcss")){link.setAttribute("data-loadcss",!0);rp.bindMediaToggle(link)}}};if(!rp.support()){rp.poly();var run=w.setInterval(rp.poly,500);if(w.addEventListener){w.addEventListener("load",function(){rp.poly();w.clearInterval(run)})}else if(w.attachEvent){w.attachEvent("onload",function(){rp.poly();w.clearInterval(run)})}} if(typeof exports!=="undefined"){exports.loadCSS=loadCSS} else{w.loadCSS=loadCSS}}(typeof global!=="undefined"?global:this)) </script></head><body class="site"> <!-- Google Tag Manager (noscript) --> <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KDHGNV6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> <!-- End Google Tag Manager (noscript) --><header class="header" itemscope itemtype="http://schema.org/SiteNavigationElement" aria-label="Main navigation"><div class="container"><div class="header__inner"> <a class="header__logo" href="/"><div class="header__logo--container"> <svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 294.779 205.349"><defs><style>.cls-1{fill:#fff;}.cls-2{font-size:28px;font-family:Roboto-Medium, Roboto;font-weight:500;}</style></defs><path d="M177.284,200.364a80.333,80.333,0,0,0-16.5,6c-7.8,3.9-11,6.2-18.1,13.3-13.9,14-20.2,29.2-20.3,49.1-.1,12.8,1.3,18.7,7,30.8,14,29.2,47.8,45.1,78.9,37.2,14.7-3.8,29-13.2,44-29.2l7.5-8,7.5,8c15,16,29.3,25.4,44,29.2,36.3,9.3,74.5-13.9,84.2-51,2.3-8.7,2.3-25.3,0-34a95.883,95.883,0,0,0-5.9-15c-7.7-15.8-24.3-29.6-42.2-35.2-8.1-2.5-22.4-3.4-31.1-1.9-15.9,2.8-33.4,12.5-48.4,26.8l-8.2,7.9-8.1-7.9C228.184,203.964,203.384,195.164,177.284,200.364Z" transform="translate(-112.404 -133.469)"/><path class="cls-1" d="M348.384,203.264c19.3,6.4,32.8,18.5,41.5,37,5.9,12.7,7.6,25.5,4.6,34.1-5.4,15.2-15,23.1-32.5,27-8.8,2-28.4,1.5-34.7-.8l-3.9-1.5,5.4-.7c24.7-3.2,35.2-32.1,18.2-50a34.28,34.28,0,0,0-17.9-9.2c-9-1.3-20,5-34.7,20.1l-8.1,8.3-8.1-10.1c-4.5-5.6-10.3-12.8-12.9-16l-4.8-5.8,5.9-6c14.7-15,32.2-25.2,49.5-28.9C323.684,199.164,339.684,200.364,348.384,203.264Z" transform="translate(-112.404 -133.469)"/><path class="cls-1" d="M184.684,227.864a58.838,58.838,0,0,1,21.5,13c3.6,3.3,6.5,6.4,6.4,6.7-.1.4,4.2,5.1,9.5,10.4,5.3,5.4,9.7,10.2,9.7,10.6,0,1.6-11.9,14-18.3,19-9.4,7.4-14.1,9.6-21,9.5-20-.3-33.2-22.4-24.3-40.7,7.8-16,28.2-20.9,40.9-9.8.9.8,2,1.2,2.3.9,1-1-8.1-6.3-13.1-7.7-11.1-3.1-25.7,4.6-31.6,16.8-3.2,6.7-3.2,17.8.1,24.6,5.9,12.2,20.3,19.7,31.7,16.7,6.3-1.7,15.9-8.7,25.8-18.7l9-9.1,9.5,10.4c5.2,5.7,11,12.2,12.9,14.4l3.4,3.9-9.4,9.6c-16.6,16.9-29.3,24.9-44.9,28-38.4,7.7-75.4-19.2-81-58.8-2.3-16.1,3.1-33.1,13.4-42,2.8-2.4,10.1-6.2,15.1-7.8C160.884,224.964,175.784,224.964,184.684,227.864Z" transform="translate(-112.404 -133.469)"/><path class="cls-1" d="M338.484,243.364c9.8,4.7,15.5,13.9,15.5,25.4,0,11.6-5.6,20.6-15.9,25.6-12.8,6.3-22.9,2.7-40-14.2-5.7-5.6-10.3-10.7-10.3-11.4,0-2.1,19.3-20.3,25.3-23.9C322.684,239.264,328.884,238.864,338.484,243.364Z" transform="translate(-112.404 -133.469)"/><text class="cls-2" transform="translate(0 55.323)">Where will you go next?</text><text x="-112.404" y="-133.469"/></svg></div></a><nav class="header__links"><div class="container header__links-wrapper"> <a class="header__link" href="/" itemprop="url"> <span itemprop="name">Home</span> </a> <a class="header__link" href="/about" itemprop="url"> <span itemprop="name">About</span> </a> <a class="header__link" href="/categories" itemprop="url"> <span itemprop="name">Categories</span> </a> <a class="header__link" href="/contact" itemprop="url"> <span itemprop="name">Contact</span> </a></div></nav><div class="header__toggle"> <span></span> <span></span> <span></span></div></div></div></header><div class="hero lazyload" data-bg="http://localhost:4000/assets/img/posts/imessage-parsing-slim.jpg"><div class="hero__wrap"><div class="hero__categories"> <a class="label" href="/categories/#Development">Development</a> &nbsp; <a class="label" href="/categories/#Favorites">Favorites</a></div><h1 class="hero__title">iMessage Parsing and Analysis</h1><p class="hero__meta"> <span> <time>05 Jun 2022</time>&nbsp;&middot; </span> <span> 13 mins read </span></p></div></div><main class="site__content"><div class="container"><article class="post-content" itemprop="articleBody"><p>You know what kinda sucks? A lot of basic features in iMessages on both macOS and iOS. So I’ve built a command line tool dubbed <code class="language-plaintext highlighter-rouge">messages</code> to help alleviate some of those pains.</p><h1 id="background">Background</h1><p>I have a few complaints and feature requests that I think would be really nice to have with iMessages. There’s a lot that lefts to be desired with searching and aggregating text messages in iMessage.</p><p>However, a pretty simple workaround is utilizing the sqlite3 database that’s populated once you set up iMessage if you have a Mac. I haven’t done any research on Windows platforms, so I’ll leave that as an exercise to the reader.</p><p><span style="color:blue">Note, if you’re just interested in code, you can skip all this and check out <a href="https://github.com/johnlarkin1/imessage-cli">this repo</a>.</span></p><h1 id="table-of-contents">Table of Contents</h1><ul><li><a href="#background">Background</a></li><li><a href="#introduction">Introduction</a><ul><li><a href="#existing-features">Existing Features</a></li><li><a href="#future-features">Future Features</a></li></ul></li><li><a href="#imessage-sqlite-table-schema">iMessage Sqlite Table Schema</a></li><li><a href="#technical-details">Technical Details</a><ul><li><a href="#enhanced-search">Enhanced Search</a><ul><li><a href="#driving-query">Driving Query</a></li><li><a href="#examples">Examples</a></li><li><a href="#performance">Performance</a></li></ul></li><li><a href="#message-dump">Message Dump</a><ul><li><a href="#driving-query-1">Driving Query</a></li><li><a href="#examples-1">Examples</a></li><li><a href="#performance-1">Performance</a></li></ul></li><li><a href="#light-trend-analysis">Light Trend Analysis</a><ul><li><a href="#most-texted-friends">Most Texted Friends</a><ul><li><a href="#driving-query-2">Driving Query</a></li><li><a href="#examples-2">Examples</a></li><li><a href="#performance-2">Performance</a></li></ul></li><li><a href="#vader-results">Vader Results</a><ul><li><a href="#driving-query-3">Driving Query</a></li><li><a href="#examples-3">Examples</a></li><li><a href="#performance-3">Performance</a></li></ul></li><li><a href="#total-number-of-distinct-convos">Total Number of Distinct Convos</a><ul><li><a href="#examples-4">Examples</a></li></ul></li></ul></li></ul></li><li><a href="#conclusion">Conclusion</a></li></ul><h1 id="introduction">Introduction</h1><p>What I did throughout this project was built a small command line tool (or CLI) tool so that you could more easily and more performantly interact with your iMessages.</p><p>Check out some of the features below.</p><h2 id="existing-features">Existing Features</h2><ul><li>Enhanced Search<ul><li>Search for a string of text on a specific day, by a specific contact, or just generally.</li></ul></li><li>Message Dump<ul><li>Scrolling back in your messages and aggregating all of that into a single stream is not easy to do</li><li>You should be able to dump all of your messages from a specific person or number on a certain date</li></ul></li><li>Light Trend and Sentiment Analysis<ul><li>Aggregated VADER analysis on messages</li><li>Top texted friends</li><li>Total number of distinct messages</li></ul></li></ul><h2 id="future-features">Future Features</h2><p>Some of these are in the pipeline, and I’m hoping to do a follow up post expanding on some of these in the near future.</p><ul><li>word cloud across all messages ever sent / received to see overarching trends</li><li><code class="language-plaintext highlighter-rouge">--before</code> and <code class="language-plaintext highlighter-rouge">--after</code> filters for <code class="language-plaintext highlighter-rouge">search</code> so that you can specify how many messages to look before or after a given search string<ul><li>This is similar to <code class="language-plaintext highlighter-rouge">grep</code>’s <code class="language-plaintext highlighter-rouge">-B</code> and <code class="language-plaintext highlighter-rouge">-A</code> arguments</li></ul></li><li>model generation<ul><li>I will cover this in another post</li></ul></li><li>expand functionality for group chats</li><li>search over a given time range</li></ul><h1 id="imessage-sqlite-table-schema">iMessage Sqlite Table Schema</h1><p>At a high level, the following tables were available:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    sqlite&gt; .tables
    _SqliteDatabaseProperties
    kvtable
    attachment - metadata and storage location
    message - all messages sent and received
    chat - a collection of your messages (both direct and group)
    message_attachment_join - join table
    chat_handle_join - join table
    message_processing_task -
    chat_message_join
    sync_deleted_attachments
    deleted_messages
    sync_deleted_chats
    handle - metadata about chats
    sync_deleted_messages
</code></pre></div></div><p>The main tables that we utilize to get information are the <code class="language-plaintext highlighter-rouge">chat</code> and <code class="language-plaintext highlighter-rouge">message</code> tables, as well as the <code class="language-plaintext highlighter-rouge">join</code> tables. There are additional tables we use to pull in contact information.</p><!-- TODO(@LARKIN): Draw a diagram --><h1 id="technical-details">Technical Details</h1><p><span style="color:red">Note: all these examples are going to be masked. I created some light shuffling and filtering based on the environment variable <code class="language-plaintext highlighter-rouge">MASK_PII_DATA</code>, so feel free to use that accordingly as well. If you also want to mask the message text itself, you can also specify the <code class="language-plaintext highlighter-rouge">MASK_MESSAGE_TEXT</code> environment variable (as I’ll show in some examples).</span></p><p>Here’s an overivew of what you’ll get greeted with when you run the <code class="language-plaintext highlighter-rouge">messages</code> command.</p><p><img src="/images/message-parser/cli-overview.png" alt="cli-overview" class="center" /></p><p>Before we dive into the functionality, I wanted to take a brief moment to focus on the sentiment analysis we’re doing using the <code class="language-plaintext highlighter-rouge">nltk</code> python package. The sentiment analysis is using the VADER method, which is a sentiment analysis method.</p><p>It’s apparently best used for short blurbs, like tweets or in this case, iMessage texts. It also can handle slang and punctuation. In addition to being lightweight, these factors made it a good candidate for my project.</p><p>VADER stands for Valence Aware Dictionary for Sentiment Reasoning. It’s a model that can handle both positive and negative elements as well as indicates the level of intensity of those emotions.</p><p>Under the hood, it relies on a dictionary that maps lexical features to emotion intensities using sentiment scores. The sentiment score of a text can be obtained by summing up the intensity of each word.</p><p>It understands the emphasis of capital letters as well as differing punctuation.</p><p>In our code, I’m using the <code class="language-plaintext highlighter-rouge">compound</code> result to infer overall feeling. That means that if there are strongly positive elements and strongly negative elements, we might just say that the text itself is neutral.</p><p>Here are a couple examples using the model that I’m utilizing in code.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SentimentIntensityAnalyzer</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s">"This was a great movie"</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Text: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s"> Scores: </span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s">"This was a great movie!!"</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Text: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s"> Scores: </span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s">"This was a GREAT movie!!"</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Text: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s"> Scores: </span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="n">text</span> <span class="o">=</span> <span class="s">"This was NOT a great movie"</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">polarity_scores</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Text: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s"> Scores: </span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>


<span class="n">johnlarkin</span><span class="o">@</span><span class="n">Larkin</span><span class="o">-</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Air</span> <span class="mi">6</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">59</span><span class="err">$</span> <span class="n">python</span> <span class="n">sentiment_classifier</span><span class="p">.</span><span class="n">py</span>
<span class="n">Text</span><span class="p">:</span> <span class="n">This</span> <span class="n">was</span> <span class="n">a</span> <span class="n">great</span> <span class="n">movie</span> <span class="n">Scores</span><span class="p">:</span> <span class="p">{</span><span class="s">'neg'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">'neu'</span><span class="p">:</span> <span class="mf">0.423</span><span class="p">,</span> <span class="s">'pos'</span><span class="p">:</span> <span class="mf">0.577</span><span class="p">,</span> <span class="s">'compound'</span><span class="p">:</span> <span class="mf">0.6249</span><span class="p">}</span>
<span class="n">Text</span><span class="p">:</span> <span class="n">This</span> <span class="n">was</span> <span class="n">a</span> <span class="n">great</span> <span class="n">movie</span><span class="err">!!</span> <span class="n">Scores</span><span class="p">:</span> <span class="p">{</span><span class="s">'neg'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">'neu'</span><span class="p">:</span> <span class="mf">0.39</span><span class="p">,</span> <span class="s">'pos'</span><span class="p">:</span> <span class="mf">0.61</span><span class="p">,</span> <span class="s">'compound'</span><span class="p">:</span> <span class="mf">0.6892</span><span class="p">}</span>
<span class="n">Text</span><span class="p">:</span> <span class="n">This</span> <span class="n">was</span> <span class="n">a</span> <span class="n">GREAT</span> <span class="n">movie</span><span class="err">!!</span> <span class="n">Scores</span><span class="p">:</span> <span class="p">{</span><span class="s">'neg'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">'neu'</span><span class="p">:</span> <span class="mf">0.356</span><span class="p">,</span> <span class="s">'pos'</span><span class="p">:</span> <span class="mf">0.644</span><span class="p">,</span> <span class="s">'compound'</span><span class="p">:</span> <span class="mf">0.7519</span><span class="p">}</span>
<span class="n">Text</span><span class="p">:</span> <span class="n">This</span> <span class="n">was</span> <span class="n">NOT</span> <span class="n">a</span> <span class="n">great</span> <span class="n">movie</span> <span class="n">Scores</span><span class="p">:</span> <span class="p">{</span><span class="s">'neg'</span><span class="p">:</span> <span class="mf">0.452</span><span class="p">,</span> <span class="s">'neu'</span><span class="p">:</span> <span class="mf">0.548</span><span class="p">,</span> <span class="s">'pos'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s">'compound'</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5096</span><span class="p">}</span>
</code></pre></div></div><p>Overall, it’s not super sophisticated, but for our use case, this seems acceptable.</p><p><a href="https://towardsdatascience.com/sentimental-analysis-using-vader-a3415fef7664">Here’s</a> another reference to some more information about the VADER method.</p><h2 id="enhanced-search">Enhanced Search</h2><p>In this section, we’ll unpack the <code class="language-plaintext highlighter-rouge">search</code> sub-command.</p><p>You can either search by contact name or contact number. There’s a limit number that you can specify as well in case you don’t want to push all the messages to <code class="language-plaintext highlighter-rouge">stdout</code>.</p><p>Here’s the driving core part of the query (not pulling in contact information) for a lot of the search logic.</p><h3 id="driving-query">Driving Query</h3><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="nb">datetime</span> <span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nb">date</span> <span class="o">/</span> <span class="mi">1000000000</span> <span class="o">+</span> <span class="n">strftime</span> <span class="p">(</span><span class="nv">"%s"</span><span class="p">,</span> <span class="nv">"2001-01-01"</span><span class="p">),</span> <span class="nv">"unixepoch"</span><span class="p">,</span> <span class="nv">"localtime"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">message_date</span><span class="p">,</span>
    <span class="n">message</span><span class="p">.</span><span class="nb">text</span><span class="p">,</span>
    <span class="n">message</span><span class="p">.</span><span class="n">is_from_me</span><span class="p">,</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">chat_identifier</span>
<span class="k">FROM</span>
    <span class="n">chat</span>
<span class="k">JOIN</span> <span class="n">chat_message_join</span> <span class="k">ON</span> <span class="n">chat</span><span class="p">.</span> <span class="nv">"ROWID"</span> <span class="o">=</span> <span class="n">chat_message_join</span><span class="p">.</span><span class="n">chat_id</span>
<span class="k">JOIN</span> <span class="n">message</span> <span class="k">ON</span> <span class="n">chat_message_join</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span> <span class="nv">"ROWID"</span>
<span class="k">WHERE</span>
    <span class="n">message</span><span class="p">.</span><span class="nb">text</span> <span class="k">like</span> <span class="s1">'%{search_text}%'</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">message_date</span> <span class="k">ASC</span><span class="p">;</span>
</code></pre></div></div><h3 id="examples">Examples</h3><p>Here are a couple of examples of ways you can search. The results are quick (and given you’re searching across all of your message history ever) it seems more performant than normal iOS searching (and probably about the same as searching across your Mac).</p><p><img src="/images/message-parser/cli-search-overview.png" alt="cli-search" /></p><p>You can also see from the following example that we’ll reject the command if no search text is specified.</p><p><img src="/images/message-parser/cli-search-ex-pt1.png" alt="cli-search-ex1" /></p><p>Here’s an example of masking the actual message text as well.</p><p><img src="/images/message-parser/cli-search-ex-pt2.png" alt="cli-search-ex2" /></p><p><img src="/images/message-parser/cli-search-ex-pt3.png" alt="cli-search-ex3" /></p><p>You can see a couple of nice things about this output - although definitely not the UI given that was not the focus of the project. We’re incorporating the Vader sentiment analysis result and analyzing if the text is positive or negative. We also are including who sent or received the message.</p><h3 id="performance">Performance</h3><p>Again, it’d be worthwhile for me to do more extensive timing tests, but on first glance, it looks pretty good.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(custom_chatbot)
johnlarkin@Larkin-MacBook-Air 16:45:08$ time MASK_PII_DATA=1 messages search -n 513******* "Nadal"
0.14s user 0.03s system 96% cpu 0.183 total
</code></pre></div></div><p>That’s scanning over messages all the way back to 2015 and doing it in less than half a second. So… I’ll take that.</p><h2 id="message-dump">Message Dump</h2><p>The <code class="language-plaintext highlighter-rouge">get</code> or message dump command is going to not require any search text, but going to have a similar output to the search command.</p><p><img src="/images/message-parser/cli-get-overview.png" alt="get-overivew" /></p><p>Again, the other nice feature with the <code class="language-plaintext highlighter-rouge">get</code> command is that you can dump all of the messages across all of your different contacts for a given date. (I didn’t choose to incorporate this feature into search because I thought it redundant to constrain a search space to an individual day).</p><h3 id="driving-query-1">Driving Query</h3><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="nb">datetime</span> <span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="nb">date</span> <span class="o">/</span> <span class="mi">1000000000</span> <span class="o">+</span> <span class="n">strftime</span> <span class="p">(</span><span class="nv">"%s"</span><span class="p">,</span> <span class="nv">"2001-01-01"</span><span class="p">),</span> <span class="nv">"unixepoch"</span><span class="p">,</span> <span class="nv">"localtime"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">message_date</span><span class="p">,</span>
    <span class="n">message</span><span class="p">.</span><span class="nb">text</span><span class="p">,</span>
    <span class="n">message</span><span class="p">.</span><span class="n">is_from_me</span><span class="p">,</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">chat_identifier</span><span class="p">,</span>
    <span class="n">IFNULL</span><span class="p">(</span><span class="n">adb_record</span><span class="p">.</span><span class="n">ZFIRSTNAME</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">IFNULL</span><span class="p">(</span><span class="n">adb_record</span><span class="p">.</span><span class="n">ZLASTNAME</span><span class="p">,</span> <span class="s1">'N/A'</span><span class="p">)</span>
<span class="k">FROM</span>
    <span class="n">chat</span>
<span class="k">JOIN</span> <span class="n">chat_message_join</span> <span class="k">ON</span> <span class="n">chat</span><span class="p">.</span> <span class="nv">"ROWID"</span> <span class="o">=</span> <span class="n">chat_message_join</span><span class="p">.</span><span class="n">chat_id</span>
<span class="k">JOIN</span> <span class="n">message</span> <span class="k">ON</span> <span class="n">chat_message_join</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span> <span class="nv">"ROWID"</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">adb</span><span class="p">.</span><span class="n">ZABCDPHONENUMBER</span> <span class="n">adb_phone</span>
    <span class="k">ON</span> <span class="n">chat</span><span class="p">.</span><span class="n">chat_identifier</span> <span class="k">like</span> <span class="s1">'%'</span> <span class="o">||</span> <span class="k">replace</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="n">adb_phone</span><span class="p">.</span><span class="n">ZFULLNUMBER</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">'+'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">')'</span><span class="p">,</span> <span class="s1">''</span><span class="p">),</span> <span class="s1">'('</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">adb</span><span class="p">.</span><span class="n">ZABCDRECORD</span> <span class="n">adb_record</span>
    <span class="k">ON</span> <span class="n">adb_phone</span><span class="p">.</span><span class="n">ZOWNER</span> <span class="o">=</span> <span class="n">adb_record</span><span class="p">.</span><span class="n">Z_PK</span>
<span class="k">WHERE</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">chat_identifier</span> <span class="k">like</span> <span class="s1">'%{get_number}'</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">message_date</span> <span class="k">ASC</span><span class="p">;</span>
</code></pre></div></div><h3 id="examples-1">Examples</h3><p><img src="/images/message-parser/cli-get-ex-pt1.png" alt="cli-get-ex1" /></p><p><img src="/images/message-parser/cli-get-ex-pt2.png" alt="cli-get-ex2" /></p><h3 id="performance-1">Performance</h3><p>This one is a bit more juicy because we’ve got a lot of data. There are ~55k messages that we’re formatting, doing some light sentiment analysis on each text, aggregating those results, and writing to <code class="language-plaintext highlighter-rouge">stdout</code> as part of this query. So… it’s certainly not trivial.</p><p>Here’s a performance example.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(custom_chatbot)
johnlarkin@Larkin-MacBook-Air 17:26:44$ time MASK_PII_DATA=1 MASK_MESSAGE_TEXT=1 messages get -c "W****"
175.18s user 2.50s system 86% cpu 3:24.32 total
</code></pre></div></div><h2 id="light-trend-analysis">Light Trend Analysis</h2><h3 id="most-texted-friends">Most Texted Friends</h3><p>Note, that this will not include contacts from which you’ve deleted the entire message history from (read: it might not include some of your exes).</p><p><img src="/images/message-parser/cli-contacts-overview.png" alt="cli-contacts-overview" /></p><h4 id="driving-query-2">Driving Query</h4><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">chat_identifier</span><span class="p">,</span>
    <span class="k">count</span><span class="p">(</span><span class="n">chat</span><span class="p">.</span><span class="n">chat_identifier</span><span class="p">)</span> <span class="k">AS</span> <span class="n">message_count</span>
<span class="k">FROM</span>
    <span class="n">chat</span>
<span class="k">JOIN</span> <span class="n">chat_message_join</span>
    <span class="k">ON</span> <span class="n">chat</span><span class="p">.</span><span class="n">ROWID</span> <span class="o">=</span> <span class="n">chat_message_join</span><span class="p">.</span><span class="n">chat_id</span>
<span class="k">JOIN</span> <span class="n">message</span> 
    <span class="k">ON</span> <span class="n">chat_message_join</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">message</span><span class="p">.</span><span class="n">ROWID</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">chat</span><span class="p">.</span><span class="n">chat_identifier</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">message_count</span> <span class="k">DESC</span><span class="p">;</span>
</code></pre></div></div><h4 id="examples-2">Examples</h4><p>Here are some example results. You’ll note that some of the most texted contacts match <code class="language-plaintext highlighter-rouge">chat.*</code> regex which means they’re just group chats that have a set unique id.</p><p><img src="/images/message-parser/cli-contacts-ex-pt1.png" alt="cli-contacts-ex1" /></p><h4 id="performance-2">Performance</h4><p>This will not be analyzed for this section.</p><h3 id="vader-results">Vader Results</h3><h4 id="driving-query-3">Driving Query</h4><p>I’m doing most of the analysis of te actual message text in Python, so there’s no real query to show here.</p><h4 id="examples-3">Examples</h4><p>The examples from above should cover the analysis. We’re simply doing a running average in terms of the aggregate VADER score. Something similar to:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for message in results:
    score = self.sentiment_model.analyze_message(message)
    sum_compound_score += score.compound
aggregate_score = sum_compound_score / len(results)
</code></pre></div></div><h4 id="performance-3">Performance</h4><p>This will not be analyzed for this section.</p><h3 id="total-number-of-distinct-convos">Total Number of Distinct Convos</h3><p>This one is a simple one, so once again a <strong>Driving Query</strong> and <strong>Performance</strong> section will not be included.</p><h4 id="examples-4">Examples</h4><p><img src="/images/message-parser/cli-total-convos.png" alt="cli-total-convos" /></p><h1 id="conclusion">Conclusion</h1><p>This was another good exploration of some new technology that I wasn’t as familiar with.</p><ul><li>Infrastructure<ul><li>Compared to the <a href="/2022/porvata-dev/">Porvata project</a>, this project really didn’t require many infrastructure tools. It was good exposure into <code class="language-plaintext highlighter-rouge">setuptools</code> with Python<ul><li>I hope to eventually push this to <code class="language-plaintext highlighter-rouge">pip</code> so that people can quickly install if they so desire</li></ul></li><li>All of the code runs locally so there aren’t any server interactions</li><li>Standard Python development tools<ul><li><a href="https://black.readthedocs.io/en/stable/">black</a> formatting</li><li><a href="http://mypy-lang.org/">mypy</a> validation</li><li><a href="https://pylint.pycqa.org/en/latest/">pylint</a> linting</li></ul></li></ul></li><li>Software<ul><li>Some good exposure to some popular Python packages<ul><li><a href="https://click.palletsprojects.com/en/8.1.x/">click</a></li><li><a href="https://docs.python.org/3/library/sqlite3.html">sqlite3</a></li><li><a href="https://www.nltk.org/">nltk</a></li><li><a href="https://docs.python.org/3/library/datetime.html">datetime</a></li><li><a href="https://docs.python.org/3/library/random.html">random</a></li></ul></li></ul></li></ul></article><div class="post-content controls__inner"><div class="controls__item prev"> <span>Previous</span> <a href="/2022/france-trip/"> <span> <svg xmlns="http://www.w3.org/2000/svg" width="6" height="11"><path fill="fillColor" d="M5.647 1.718c.37-.434.323-1.09-.106-1.465A1.016 1.016 0 0 0 4.095.36L.25 4.875a1.05 1.05 0 0 0 .017 1.378l3.95 4.407c.38.424 1.03.456 1.448.07a1.05 1.05 0 0 0 .07-1.468l-3.34-3.725 3.253-3.819z"/> </svg> </span> Nice, Barca, Paris + French... </a></div><div class="controls__item next"> <span>Next</span> <a href="/2022/invisible-ink/"> Invisible Ink <span> <svg xmlns="http://www.w3.org/2000/svg" width="6" height="11"><path fill="#fillColor" d="M.353 9.282c-.37.434-.323 1.09.106 1.465a1.016 1.016 0 0 0 1.446-.107L5.75 6.125a1.05 1.05 0 0 0-.017-1.378L1.784.34A1.015 1.015 0 0 0 .336.27a1.05 1.05 0 0 0-.07 1.468l3.34 3.725L.353 9.282z"/> </svg> </span> </a></div></div></div><div class="comments"><div class="container"><div class="post-content"><div id="disqus_thread"></div><script> var disqus_config = function () { this.page.url = 'http://localhost:4000/2022/message-parser/'; this.page.identifier = 'http://localhost:4000/2022/message-parser/'; }; (function() { var d = document, s = d.createElement('script'); s.src = 'https://jlarks32.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the comments.</noscript></div></div></div></main><footer class="footer"><div class="container"><nav class="social"> <a class="social__link" target="_blank" rel="noopener noreferrer" href="https://github.com/johnlarkin1"> <svg class="social__icon" viewBox="0 0 20 20" width="20px" height="20px"><path d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg> </a></nav><span>&copy; 2023 Where will you go next?. All rights reserved.</span></div></footer><script async src="/assets/js/bundle.js"></script></body></html>
